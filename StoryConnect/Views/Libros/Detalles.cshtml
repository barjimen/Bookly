@model LibrosDetalles
@{
    ViewData["Title"] = "Detalles";
}

<div class="container my-4">
    <!-- Book Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a asp-action="Index">Inicio</a></li>
                    <li class="breadcrumb-item active" aria-current="page">@Html.DisplayFor(model => model.Libro.Titulo)</li>
                </ol>
            </nav>
        </div>
    </div>

    <div class="row">
        <!-- Left Column: Book Cover -->
        <div class="col-md-3 mb-4">
            <div class="text-center">
                @if (Model.Libro.ImagenPortada != null)
                {
                    <img src="~/images/books/@Model.Libro.ImagenPortada" alt="Portada de @Model.Libro.Titulo" class="img-fluid rounded shadow book-cover" />
                }
                else
                {
                    <div class="border rounded p-5 text-center bg-light book-cover-placeholder">
                        <i class="bi bi-book" style="font-size: 3rem;"></i>
                        <p class="mt-2">Sin imagen</p>
                    </div>
                }

                <!-- Action Buttons -->
                <div class="btn-group dropright">
                    <button class="btn dropdown-toggle
                                                @(Model.ListaLibro == 1 ? "btn-primary" :
                                                  Model.ListaLibro == 2 ? "btn-success" :
                                                  Model.ListaLibro == 3 ? "btn-warning" :
                                                  Model.ListaLibro == 4 ? "btn-black" :"btn-secondary")"
                            type="button" id="dropdownMenuButton-@Model.ListaLibro"
                            data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">

                        @if (Model.ListaLibro == 0)
                        {
                            <span>Añadir a lista</span>
                        }
                        else if (Model.ListaLibro == 1)
                        {
                            <span>Leyendo</span>
                        }
                        else if (Model.ListaLibro == 2)
                        {
                            <span>Leído</span>
                        }
                        else if (Model.ListaLibro == 3)
                        {
                            <span>Próxima Lectura</span>
                        }
                        else if (Model.ListaLibro == 4)
                        {
                            <span>No terminado</span>
                        }
                    </button>

                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton-@Model.Libro.Id">
                        <button class="dropdown-item dropdown-libro mover-libro" data-idLibro="@Model.Libro.Id" data-destino="1" data-origen="@Model.ListaLibro">Leyendo</button>
                        <button class="dropdown-item dropdown-libro mover-libro" data-idLibro="@Model.Libro.Id" data-destino="2" data-origen="@Model.ListaLibro">Leído</button>
                        <button class="dropdown-item dropdown-libro mover-libro" data-idLibro="@Model.Libro.Id" data-destino="3" data-origen="@Model.ListaLibro">Próxima Lectura</button>
                        <button class="dropdown-item dropdown-libro mover-libro" data-idLibro="@Model.Libro.Id" data-destino="4" data-origen="@Model.ListaLibro">No Terminado</button>
                        <button class="dropdown-item dropdown-libro mover-libro" data-idLibro="@Model.Libro.Id" data-destino="0" data-origen="@Model.ListaLibro">Eliminar</button>
                    </div>
                </div>

                <!-- Edition Info -->
                <div class="mt-3 text-start small">
                    <div class="text-muted mb-1">Edición:</div>
                    <div>Pasta blanda, @Html.DisplayFor(model => model.Libro.NumeroPaginas) páginas</div>
                    <div>Publicado: @Model.Libro.FechaPublicacion.ToShortDateString()</div>
                </div>
            </div>
        </div>

        <!-- Right Column: Book Details -->
        <div class="col-md-9">
            <div class="mb-3">
                <h1 class="book-title mb-1">@Html.DisplayFor(model => model.Libro.Titulo)</h1>
                <h4 class="text-muted author-name">por <a asp-action="Details" asp-controller="Autores" asp-route-idautor="@Model.Libro.AutorId" class="text-decoration-none">@Html.DisplayFor(model => model.Libro.NombreAutor)</a></h4>

                @if (!string.IsNullOrEmpty(Model.Libro.Saga))
                {
                    <div class="mb-2 text-muted">
                        <span class="badge bg-light text-dark border">@Html.DisplayFor(model => model.Libro.Saga) #@Html.DisplayFor(model => model.Libro.PosicionSaga)</span>
                    </div>
                }
            </div>

            <!-- Ratings Display -->
            <div class="mb-4 rating-section">
                <div class="d-flex align-items-center">
                    <div class="me-3">
                        <span class="display-6 fw-bold">@Model.Libro.CalificacionPromedio.ToString("0.00")</span>
                    </div>
                    <div class="review-rating">
                        @for (int i = 1; i <= 5; i++)
                        {
                            if (i <= Math.Floor(Model.Libro.CalificacionPromedio))
                            {
                                <i class="fa fa-star filled"></i> <!-- Full star -->
                            }
                            else if (i == Math.Ceiling(Model.Libro.CalificacionPromedio) && Model.Libro.CalificacionPromedio % 1 != 0)
                            {
                                <i class="fa fa-star-half-alt filled"></i> <!-- Half star -->
                            }
                            else
                            {
                                <i class="fa fa-star empty"></i> <!-- Empty star -->
                            }
                        }
                    </div>

                    <div class="ms-auto">
                        <button class="btn btn-outline-secondary btn-sm">
                            <i class="bi bi-star me-1"></i>Calificar este libro
                        </button>
                    </div>

                </div>
            </div>

            <!-- Tags Section (NEW) -->
            <div class="mb-4 tags-section">
                <h4>Etiquetas</h4>
                <div class="etiquetas-container">
                    @if (Model.Etiquetas != null && Model.Etiquetas.Any())
                    {
                        @foreach (var etiqueta in Model.Etiquetas)
                        {
                            <a href="@Url.Action("LibrosPorEtiqueta", "Libros", new { etiquetaId = etiqueta.Id })"
                               class="badge bg-primary text-decoration-none me-2 mb-2 py-2 px-3">
                                @etiqueta.Nombre
                            </a>
                        }
                    }
                    else
                    {
                        <p class="text-muted fst-italic">No hay etiquetas para este libro.</p>
                    }
                </div>
            </div>

            <!-- Synopsis Section -->
            <div class="mb-4 sinopsis-section">
                <h4>Sinopsis</h4>
                <p>@Html.DisplayFor(model => model.Libro.Sinopsis)</p>
            </div>
            
            <!-- Book Metadata -->
            <div class="mb-4 metadata-section">
                <h4>Información del libro</h4>
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                <tr>
                                    <th scope="row" class="text-muted">ID:</th>
                                    <td>@Html.DisplayFor(model => model.Libro.Id)</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-muted">Título:</th>
                                    <td>@Html.DisplayFor(model => model.Libro.Titulo)</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-muted">Autor:</th>
                                    <td>@Html.DisplayFor(model => model.Libro.NombreAutor)</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-muted">Páginas:</th>
                                    <td>@Html.DisplayFor(model => model.Libro.NumeroPaginas)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tbody>
                                @if (!string.IsNullOrEmpty(Model.Libro.Saga))
                                {
                                    <tr>
                                        <th scope="row" class="text-muted">Saga:</th>
                                        <td>@Html.DisplayFor(model => model.Libro.Saga)</td>
                                    </tr>
                                    <tr>
                                        <th scope="row" class="text-muted">Posición:</th>
                                        <td>@Html.DisplayFor(model => model.Libro.PosicionSaga)</td>
                                    </tr>
                                }
                                <tr>
                                    <th scope="row" class="text-muted">Fecha Publicación:</th>
                                    <td>@Html.DisplayFor(model => model.Libro.FechaPublicacion)</td>
                                </tr>
                                <tr>
                                    <th scope="row" class="text-muted">ID Autor:</th>
                                    <td>@Html.DisplayFor(model => model.Libro.AutorId)</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <hr />
    <div class="reviews-container">
        <h2>Reseñas: @Model.Resenas.Count() </h2>

        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal">
            Añadir una reseña
        </button>

        <!-- Modal para Añadir Reseña -->
        <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5" id="exampleModalLabel">Añadir Reseña</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="formReseña" method="post" action="/Libros/InsertReseña">
                        <div class="modal-body">
                            <label for="reseñaTexto">Reseña: </label>
                            <input type="text" class="form-control" id="texto" name="texto" placeholder="El libro me ha parecido..." required />
                            <input type="hidden" id="idLibro" name="idLibro" value="@Model.Libro.Id" />

                            <div class="mb-3">
                                <label class="form-label">Calificación</label>
                                <select id="calificacion" class="form-control" name="calificacion">
                                    <option value="1">1 ⭐</option>
                                    <option value="2">2 ⭐⭐</option>
                                    <option value="3">3 ⭐⭐⭐</option>
                                    <option value="4">4 ⭐⭐⭐⭐</option>
                                    <option value="5">5 ⭐⭐⭐⭐⭐</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                            <button type="submit" class="btn btn-primary">Guardar reseña</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>



        @foreach (var review in Model.Resenas)
        {
            <div class="review-card">
                <div class="review-header">
                    <div class="review-id">
                        <span class="label">Review #</span>
                        <span class="value">@review.Id</span>
                    </div>
                    <div class="review-date">
                        <i class="fa fa-calendar"></i>
                        <span>@review.fecha.ToString()</span>
                    </div>
                </div>

                <div class="review-user">
                    <div class="user-avatar">
                        <i class="fa fa-user-circle"></i>
                    </div>
                    <div class="user-id">User @review.Usuario.Nombre</div>
                </div>

                <div class="review-rating">
                    @for (int i = 1; i <= 5; i++)
                    {
                        if (i <= review.calificacion)
                        {
                            <i class="fa fa-star filled"></i>
                        }
                        else
                        {
                            <i class="fa fa-star empty"></i>
                        }
                    }
                    <span class="points">@review.calificacion/5</span>
                </div>

                <div class="review-text">
                    <p>@review.texto</p>
                </div>
                <button class="btn btn-primary editar-resena"
                        data-idresena="@review.Id"
                        data-usuario="@review.Usuario.Nombre"
                        data-calificacion="@review.calificacion"
                        data-texto="@review.texto"
                        data-idLibro="@review.idLibro">
                        
                        
                    <i class="fa fa-edit"></i> Editar
                </button>

            </div>
        }
        <!--El modal para editar reseña-->
        <div class="modal fade" id="modalEditar" tabindex="-1" aria-labelledby="modalEditarLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="modalEditarLabel">Editar Reseña</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="formReseña" method="post" action="/Libros/ActualizarReseña">
                            <div class="mb-3">
                                <input type="hidden" id="idResena" name="Id" />
                                <input type="hidden" id="idLibro" name="idLibro" value="@Model.Libro.Id" />
                                <label class="form-label">Usuario</label>
                                <input type="text" id="usuario" class="form-control" disabled />
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Calificación</label>
                                <select id="calificacion" class="form-control" name="calificacion">
                                    <option value="1">1 ⭐</option>
                                    <option value="2">2 ⭐⭐</option>
                                    <option value="3">3 ⭐⭐⭐</option>
                                    <option value="4">4 ⭐⭐⭐⭐</option>
                                    <option value="5">5 ⭐⭐⭐⭐⭐</option>
                                </select>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Texto de la reseña</label>
                                <textarea id="texto" class="form-control" name="texto"></textarea>
                            </div>


                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" id="actualizarReseña">Guardar cambios</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Buttons at the bottom -->
        <div class="mt-4 mb-4 d-flex">
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Volver
            </a>
        </div>
    </div>
</div>

<!-- Add this to your site.css or in a style tag -->
<style>
    .book-cover {
        max-height: 350px;
        width: auto;
    }

    .book-cover-placeholder {
        height: 350px;
        display: flex;
        flex-direction: column;
        justify-content: center;
    }

    .book-title {
        font-size: 1.8rem;
        font-weight: 700;
    }

    .author-name {
        font-size: 1.2rem;
        font-weight: 400;
    }

    /* Star Rating CSS */
    .stars-outer {
        position: relative;
        display: inline-block;
        font-size: 1.5rem;
    }

        .stars-outer::before {
            content: "\2606 \2606 \2606 \2606 \2606";
            color: #ccc;
        }

    .stars-inner {
        position: absolute;
        top: 0;
        left: 0;
        white-space: nowrap;
        overflow: hidden;
        width: 0;
    }

        .stars-inner::before {
            content: "\2605 \2605 \2605 \2605 \2605";
            color: #f8ce0b;
        }

    .sinopsis-section {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #3c763d;
    }

    .metadata-section {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
    }

    /* Tags Section Styling */
    .tags-section {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .etiquetas-container {
        display: flex;
        flex-wrap: wrap;
        margin-top: 10px;
    }

    .reviews-container {
        font-family: 'Arial', sans-serif;
        max-width: auto;
        margin: 0 auto;
        padding: 20px;
    }

    .review-card {
        background-color: #fff;
        border-radius: 15px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 25px;
        border: 2px solid #f8bbd0;
        transition: transform 0.3s ease;
    }

        .review-card:hover {
            transform: translateY(-5px);
        }

    .review-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 15px;
        border-bottom: 2px dashed #f8bbd0;
        padding-bottom: 10px;
    }

    .review-id {
        background-color: #f8bbd0;
        border-radius: 20px;
        padding: 5px 12px;
        font-size: 14px;
        color: #880e4f;
    }

        .review-id .label {
            font-weight: bold;
        }

    .review-date {
        color: #757575;
        font-size: 14px;
    }

    .review-user {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
    }

    .user-avatar {
        background-color: #f8bbd0;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        justify-content: center;
        align-items: center;
        margin-right: 10px;
        color: #880e4f;
        font-size: 20px;
    }

    .user-id {
        font-weight: bold;
        color: #616161;
    }

    .review-rating {
        margin-bottom: 15px;
        color: #ffc107;
        font-size: 18px;
    }

        .review-rating .filled {
            color: #ffc107;
        }

        .review-rating .empty {
            color: #e0e0e0;
        }

        .review-rating .points {
            margin-left: 10px;
            color: #616161;
            font-size: 14px;
            vertical-align: middle;
        }

    .review-text {
        padding: 15px;
        background-color: #fff9fa;
        border-radius: 10px;
        border-left: 4px solid #f8bbd0;
    }

        .review-text p {
            margin: 0;
            color: #424242;
            line-height: 1.5;
        }
</style>

<!-- Add Bootstrap Icons to your _Layout.cshtml or here -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
<!-- CDN de SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="~/js/Modal.js"></script>
   